# PLG E2E Testing Container
# 
# Simple container with code-server (browser-based VS Code) for testing Mouse PLG flow.
# 
# Build:
#   docker build -f Dockerfile.plg-e2e -t plg-e2e .
#
# Run:
#   docker run -d -p 8080:8080 -v /c/Users/SimonAdmin/source/repos/hic/mouse-vscode:/vsix:ro --name plg-e2e plg-e2e
#
# Access:
#   http://localhost:8080 (password: hic123)
#
# Install Mouse (inside container terminal):
#   code-server --install-extension /vsix/mouse-0.9.9.vsix
#   # Then reload the browser

FROM codercom/code-server:latest

# Switch to root for installation
USER root

# Install Node.js 22.x
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# Install GitHub Copilot extensions (for testing Mouse + Copilot integration)
USER coder
RUN code-server --install-extension github.copilot && \
    code-server --install-extension github.copilot-chat || true

# Ensure clean license state - NO .hic directory
USER root
RUN rm -rf /home/coder/.hic /root/.hic

# Create workspace
RUN mkdir -p /workspace && chown coder:coder /workspace

# Set password for code-server
ENV PASSWORD=hic123

# Switch back to coder user
USER coder
WORKDIR /workspace

# Expose code-server port
EXPOSE 8080

# Just run code-server directly
ENTRYPOINT ["code-server", "--bind-addr", "0.0.0.0:8080", "/workspace"]
